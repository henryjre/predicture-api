<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prediction Market Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background: #f9f9f9;
      }
      canvas {
        max-width: 100%;
      }
      #chartTitle {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }
      #customLegend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 10px;
      }
      #filterButtons {
        text-align: center;
        margin: 20px 0;
      }
      .filter-btn {
        border: none;
        padding: 8px 14px;
        margin: 0 5px;
        cursor: pointer;
        background-color: #ddd;
        border-radius: 5px;
        font-weight: bold;
      }
      .filter-btn.active {
        background-color: #3062f7;
        color: white;
      }
      #loadingSpinner {
        display: none;
        text-align: center;
        margin-top: 10px;
      }
      #loadingSpinner div {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid #ccc;
        border-top: 3px solid #3062f7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      #lastUpdated {
        text-align: right;
        font-size: 0.9rem;
        color: #555;
        margin-top: 5px;
      }
      #refreshButton {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 6px 12px;
        background-color: #3062f7;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2 id="chartTitle">Loading event title...</h2>
    <button id="refreshButton">Refresh</button>
    <div id="customLegend"></div>
    <div id="filterButtons">
      <button class="filter-btn" data-range="5M">5M</button>
      <button class="filter-btn" data-range="15M">15M</button>
      <button class="filter-btn" data-range="30M">30M</button>
      <button class="filter-btn" data-range="1H">1H</button>
      <button class="filter-btn" data-range="6H">6H</button>
      <button class="filter-btn" data-range="1D">1D</button>
      <button class="filter-btn" data-range="1W">1W</button>
      <button class="filter-btn" data-range="1M">1M</button>
      <button class="filter-btn active" data-range="ALL">ALL</button>
    </div>
    <canvas id="priceChart" height="100"></canvas>
    <div id="loadingSpinner"><div></div></div>
    <p id="noDataMessage">No price data yet for this event.</p>
    <div id="lastUpdated">Last updated: --</div>
    <script>
      let originalData = [];
      let chart;
      let eventId = null;

      const rangeMap = {
        "5M": 5 * 60 * 1000,
        "15M": 15 * 60 * 1000,
        "30M": 30 * 60 * 1000,
        "1H": 60 * 60 * 1000,
        "6H": 6 * 60 * 60 * 1000,
        "1D": 24 * 60 * 60 * 1000,
        "1W": 7 * 24 * 60 * 60 * 1000,
        "1M": 30 * 24 * 60 * 60 * 1000,
      };

      async function fetchData(eventId) {
        const response = await fetch(`/api/events/${eventId}/prices`);
        return await response.json();
      }

      function updateLatestPriceMarkers(latest, colors) {
        const container = document.getElementById("customLegend");
        container.innerHTML = "";
        if (!latest || !latest.prices) return;
        Object.entries(latest.prices).forEach(([key, val], i) => {
          const div = document.createElement("div");
          div.style.display = "flex";
          div.style.alignItems = "center";
          div.style.fontWeight = "bold";
          div.style.fontSize = "1.1rem";
          const dot = document.createElement("span");
          Object.assign(dot.style, {
            display: "inline-block",
            width: "10px",
            height: "10px",
            borderRadius: "50%",
            marginRight: "6px",
            backgroundColor: colors[i % colors.length],
          });
          const lbl = document.createElement("span");
          lbl.textContent = `${key} ${(val * 100).toFixed(1)}%`;
          div.append(dot, lbl);
          container.append(div);
        });
      }

      function updateTimestamp() {
        const now = new Date();
        document.getElementById("lastUpdated").textContent =
          "Last updated: " + now.toLocaleTimeString();
      }

      function renderChart(title, data) {
        document.getElementById("chartTitle").textContent =
          title || "Untitled Event";
        const colors = ["#007bff", "#dc3545", "#6f42c1", "#28a745", "#ffc107"];
        let hasData = Array.isArray(data) && data.length > 0;
        if (!hasData) {
          document.getElementById("noDataMessage").style.display = "block";
          data = [{ snapshot_time: new Date(), prices: { A: 0, B: 0, C: 0 } }];
        } else document.getElementById("noDataMessage").style.display = "none";
        updateLatestPriceMarkers(data[data.length - 1], colors);
        const labels = data.map((d) => new Date(d.snapshot_time));
        const keys = Object.keys(data[0].prices);
        const datasets = keys.map((k, i) => ({
          label: k,
          data: data.map((d) => d.prices[k]),
          borderColor: colors[i % colors.length],
          fill: false,
          tension: 0.2,
          pointRadius: 4,
        }));
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById("priceChart"), {
          type: "line",
          data: { labels, datasets },
          options: {
            responsive: true,
            layout: { padding: { right: 50 } },
            interaction: { mode: "nearest", axis: "xy", intersect: true },
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: "nearest",
                intersect: true,
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: ${ctx.raw}`,
                },
              },
              datalabels: {
                display: true,
                align: "top",
                anchor: "end",
                formatter: (val, ctx) => {
                  const ds = ctx.chart.data.datasets[ctx.datasetIndex];
                  return ctx.dataIndex === ds.data.length - 1 ? val : null;
                },
                font: { weight: "bold", size: 12 },
                color: (ctx) => ctx.dataset.borderColor,
              },
            },
            scales: {
              x: { type: "time", time: { tooltipFormat: "MMM d, h:mm a" } },
              y: { beginAtZero: true, title: { display: true, text: "Price" } },
            },
          },
          plugins: [ChartDataLabels],
        });
      }

      function filterData(range) {
        if (range === "ALL") return originalData;
        const now = Date.now();
        return originalData.filter(
          (d) => new Date(d.snapshot_time).getTime() >= now - rangeMap[range]
        );
      }

      function setupFilters() {
        const btns = document.querySelectorAll(".filter-btn");
        const saved = localStorage.getItem("lastFilterRange") || "ALL";
        btns.forEach((b) =>
          b.classList.toggle("active", b.dataset.range === saved)
        );
        renderChart(
          document.getElementById("chartTitle").textContent,
          filterData(saved)
        );
        btns.forEach((b) =>
          b.addEventListener("click", () => {
            btns.forEach((x) => x.classList.remove("active"));
            b.classList.add("active");
            localStorage.setItem("lastFilterRange", b.dataset.range);
            renderChart(
              document.getElementById("chartTitle").textContent,
              filterData(b.dataset.range)
            );
          })
        );
      }

      async function loadAndRender() {
        document.getElementById("loadingSpinner").style.display = "block";
        try {
          const json = await fetchData(eventId);
          originalData = json.data || [];
          renderChart(
            json.title,
            filterData(localStorage.getItem("lastFilterRange") || "ALL")
          );
          updateTimestamp();
        } catch (e) {
          console.error(e);
        }
        document.getElementById("loadingSpinner").style.display = "none";
      }

      function init() {
        const params = new URLSearchParams(location.search);
        eventId = params.get("event_id");
        if (!eventId) return alert("Missing event_id");
        setupFilters();
        loadAndRender();
        document
          .getElementById("refreshButton")
          .addEventListener("click", loadAndRender);
      }
      init();
    </script>
  </body>
</html>
